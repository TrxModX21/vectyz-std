name: Deploy Production with PNPM

on:
  push:
    branches: [ "main" ] # Trigger hanya saat push ke main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # 1. Load Environment (Agar pnpm & node terbaca)
            export NVM_DIR=~/.nvm
            source ~/.nvm/nvm.sh
            
            # 2. Masuk ke folder project
            # GANTI '/var/www/my-project' dengan path folder aslimu di VPS
            cd /var/www/vectyz
            
            # 3. Tarik kode terbaru
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main
            
            # --- BACKEND ---
            echo "ðŸš€ Building Backend..."
            cd server
            # Install dependency (termasuk devDependencies utk build)
            pnpm install --frozen-lockfile
            # Generate database
            npx prisma generate
            # Build TypeScript
            pnpm build
            cd ..
            
            # --- CLIENT WEB ---
            echo "ðŸš€ Building Client Web..."
            # GANTI 'client-web' sesuai nama folder frontend client kamu
            cd client
            pnpm install --frozen-lockfile
            pnpm build
            cd ..
            
            # --- ADMIN DASHBOARD ---
            echo "ðŸš€ Building Admin Dashboard..."
            # GANTI 'admin-dashboard' sesuai nama folder admin kamu
            cd admin
            pnpm install --frozen-lockfile
            pnpm build
            cd ..
            
            # --- RELOAD PM2 ---
            echo "ðŸ”„ Reloading PM2..."
            # Update env memastikan variabel baru terbaca
            pm2 reload ecosystem.config.js --update-env
            pm2 save
            
            echo "âœ… Deployment Finished Successfully!"